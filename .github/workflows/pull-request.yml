name: Pull Request

on:
    workflow_dispatch: {}

jobs:
    build:
        name: Build Android
        runs-on: [self-hosted, linux]
        steps:
            - name: Checkout my unity project.
              uses: actions/checkout@v4
            - name: Create LFS file list
              run: git lfs ls-files -l | cut -d' ' -f1 | sort > .lfs-assets-id
            
            - name: Restore LF5 cache
              uses: actions/cache@v3
              id: lfs-cache
              with:
                path: .git/lfs
                key: ${{ runner.os }}-lsf-${{ hashFiles('.lfs-asset-id') }}
            
            - name: Git LFS Pull
              run: |
                git lfs pull
                git add .
                git reset --hard

            - name: Set outputs
              id: vars
              run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

            - uses: actions/cache@v3
              with:
                path: Library
                key: Library-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
                restore-keys: |
                Library-
            
            - name: Run the Android build
              uses: game-ci/unity-builder@v4
              env:
                UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
                UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
                UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
              with:
                targetPlatform: Android
                unityVersion: 6000.0.30f1

            - name: Upload the Android Build
              uses: actions/upload-artifact@v3
              with:
                name: Build-${{ steps.vars.outputs.sha_shors }}
                path: build
